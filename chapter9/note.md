#### 应用程序性能优化

##### 策略1：并行/串行在GPU/CPU上的问题分解

主要就是考虑问题是否可以被分解成并行运行的组块。所谓的依赖性就是一些计算需要用到以前计算的结果。可以是针对问题域的计算也可能是数组下标的计算。在这两种情况下，依赖都会引起并行执行问题。

在CPU方面，来自其他虚拟CPU核的指令流填补指令流水线的空隙。循环迭代不是免费的，因为它们需要一个循环迭代值和一个分支。降低迭代的次数可以为我们减少执行指令方面带来显著的益处。

多轮遍历的算法通常是一些内核调用的序列，效率通常是地下的。许多这样的算法可以写成只涉及单个或者少量目标数据点的内核程序。

**CPU和GPU的内存分组**

任何基于GPU的优化也必须要考虑到CPU，因为这对于总的应用程序时间很重要的。独立的CPU进程或者线程可以创建一个独立的GPU上下文。且启动他们的内核到该GPU中。GPU上的空闲时间是更加昂贵的。

我们要思考如何以最佳的方式在CPU和一个或者对个GPU之间进行分配。考虑是较少的执行时间还是处理数据以获得更高的分辨率更加重要。一般我们可以在迭代到一定的阈值之后，剩余部分的计算就转交给CPU来完成。这样的策略相比于等待GPU完成整个归约过程有着显著的收益。

对于类似归约操作的一些算法，请确保每次迭代都在减少活跃线程束的数量。

##### 内存因素

内存带宽和延迟时所有的应用程序都需要考虑的关键因素。内核通常被两个关键的因素限制：内存限制/带宽和指令延迟/带宽。如果同一个线程束上的其他线程访问的是相邻内存位置并且内存区域的位置开始是对齐的话，那么该请求就会自动地与这些线程的请求组合或者合并。

**内存组织**

CPU程序通常在内存中以行的方式安排数据。我们必须安排内存模式使得连续线程对内存的访问以列的方式进行。这个原则适用于全局内存和共享内存。我们需要保证对齐的方式。

注意权衡单，双精度及其对内存使用的影响。针对128字节的合并访问，优化访存模式，对齐到128字节的内存读取大小和一级缓存行大小。在适当的时候将多核融合成为单内核。

##### 传输

如可能，要尽量使用锁页内存，至少使用2MB的传输大小。理解零赋值内存的使用，它是流API的一种替代方法。我们会受到PCI-E带宽容量限制。

我们要想好如何将内核执行时间与传输时间重写。并且多个GPU不要期待线性的带宽增长。

##### 线程使用，计算，分支

内核启动的时候，声明的线程数量只使用32的倍数。思考如何增加实际每次内存读取时候的工作量。在优化代码和修改源代码的时候协助编译器，避免线程束的分支。

并不是所有的并行算法都可以在GPU上实现，在实现算法的时候要考虑合并和通信等方面的因素。每个线程尽可能多地处理元素数据，然而每个线程处理过多的元素也可能会对性能带来副作用。

一个多核的CPU虽然可能很好地处理计算负载，但是通常会受到内存带宽的限制，这会限制我们充分使用所有核的能力。

